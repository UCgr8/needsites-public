name: Mirror to Public

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout private repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Prepare public subset
        run: |
          set -e
          mkdir _public
          # Copy only safe folders that exist
          for p in app src components pages public lib; do
            if [ -d "$p" ]; then cp -R "$p" _public/; fi
          done
          # Root files (safe)
          for f in package.json pnpm-lock.yaml yarn.lock package-lock.json README.md LICENSE; do
            [ -f "$f" ] && cp "$f" _public/ || true
          done
          # Ensure not empty
          echo "# NeedSites Public Mirror" > _public/README.md
          # Strip private/noisy
          rm -rf _public/.git _public/.github _public/.vercel _public/node_modules || true
          echo "Files copied to _public:"
          find _public -maxdepth 2 -type f | wc -l

      - name: Verify secrets
        run: |
          if [ -z "${{ secrets.MIRROR_REPO }}" ]; then echo "MIRROR_REPO missing"; exit 1; fi
          echo "Target repo: ${{ secrets.MIRROR_REPO }}"
          if [ -z "${{ secrets.MIRROR_TOKEN }}" ]; then echo "MIRROR_TOKEN missing"; exit 1; fi
          echo "Token present"

      - name: Push subset to public mirror
        uses: JamesIves/github-pages-deploy-action@v4
        with:
          token: ${{ secrets.MIRROR_TOKEN }}
          repository-name: ${{ secrets.MIRROR_REPO }}
          branch: main
          folder: _public
          clean: true
          single-commit: true

      - name: Done
        run: echo "Mirror completed"

